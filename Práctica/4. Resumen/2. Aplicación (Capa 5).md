<h1 align="center">Capa de Aplicación (Capa 5)</h1>

## Definiciones

-   Una **red** es un conjunto de dispositivos interconectados a través de distintos medios con el principal objetivo de transmitir información y compartir recursos y/o servicios.
-   Un **protocolo** es un conjunto de reglas que define el formato y orden de los mensajes que se intercambian y las acciones que se llevan a cabo en la transmisión y/o recepción de un mensaje u otro evento.
-   Un **PDU** (Protocol Data Unit) es el tipo de dato que utiliza cada capa.
-   La **encapsulación** consiste en tomar el PDU de la capa anterior a la actual, agregarle información (headers) para convertirla en un nuevo PDU.
-   Un **User Agent** es una interfaz de usuario entre el usuario y la aplicación de red.

---

## Función de la Capa de Aplicación

-   La función de la Capa de Aplicación es proveer servicios para que las aplicaciones de usuario puedan comunicarse entre sí, ya sea que estén en una misma computadora o en computadoras distintas.
-   La idea es hacer la comunicación más amigable y user-friendly.
-   Su PDU es el **Dato**.

---

## HTTP

#### HTTP vs HTML

-   HTML es un **lenguaje** usado para estructurar páginas web mientras que HTTP es un **protocolo** para comunicar clientes con servidores.
-   HTTP usa por defecto el puerto 80.
-   HTTPS usa por defecto el puerto 443.

#### Requerimientos HTTP

Los requerimientos son pedidos que se hacen de un cliente a un servidor e incluyen el formato:

```
MétodoHTTP RecursoHTTP/VersiónHTTP
```

Por ejemplo:

```
GET /hola/test.html HTTP/1.1
```

#### Respuestas HTTP

Las respuestas son lo que el servidor le responde al cliente, y tienen el siguiente formato:

```
HTTP/Versión CódigoDeRespuesta
```

Por ejemplo:

```
HTTP/1.1 200 OK
```

#### Comando curl

Este comando sirve para realizar peticiones de varios protocolos a una URL. Cuando el HTML de la URL tiene recursos externos, el navegador hará HTTP requests separados de forma transparente para traerlos. Parámetros:

-   **-I:** Realiza una solicitud HTTP usando el método HEAD, es decir que no muestra el Body recibido, solo los headers.
-   **-H:** Agregar headers personalizados al request del tipo clave:valor.
-   **-X:** Permite especificar el método HTTP (GET, PUT, POST, etc).
-   **-s:** Silencia el progreso y no muestra mensajes de error.
-   **-v:** Verboso, muestra información detallada del request, headers de la respuesta, información de la conexión, etc.

#### Versiones de HTTP

| Versión | Protocolo de información                            | Tipo de conexiones                                                                                                                                                                             | Dominios          |
| ------- | --------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------- |
| 1.0     | Texto: ASCII por ende user friendly aunque costoso. | No persistentes: Cada request involucra una nueva conexión TCP, y esa conexión solo termina una vez que el servidor contestó.                                                                  | 1 IP → 1 dominio  |
| 1.1     | Texto: ASCII por ende user friendly aunque costoso. | Persistentes: Podemos enviar muchos requests en una misma conexión TCP de forma secuencial, y además no tenemos que esperar a recibir la respuesta del request X para enviar el request X + 1. | 1 IP → N dominios |
| 2.0     | Binario: Difícil de leer pero muy eficiente.        | Multiplexing: Similar a 1.1 pero además los requests se realizan de forma concurrente. No hay que esperar a que uno haya terminado de enviarse para enviar el siguiente.                       | 1 IP → N dominios |

#### Códigos HTTP

Son valores que se envían en una respuesta HTTP que representan lo que ocurrió con el requerimiento, si fue exitoso, si falló por alguna razón, etc.
| Código | Significado |
| ------ | --------------------- |
| 1XX | Información de estado |
| 2XX | Exito |
| 3XX | Redirección |
| 4XX | Error del Cliente |
| 5XX | Error del Servidor |

#### Headers HTTP

Son datos con el formato clave:valor que se intercambian en los requerimientos y respuestas HTTP.
| Header | Significado |
| ------------------------------------ | -------------------------------------------------------------------------------------------------------------------- |
| Accept: application/json, text/html | Tipos de datos que el cliente espera como respuesta. |
| Content-Type: application/json | Tipos de datos que se enviaron. |
| Authorization: Bearer <token> | Credenciales de autenticación que envía el cliente. |
| User-Agent: curl/7.88.1 | Datos del cliente que realizó el request. |
| Location: https://abc.com/index.html | Indica la nueva URL a la que el cliente debería redireccionarse. |
| Server: Apache2 | Datos del servidor. |
| Content-Length: 50 | Tamaño de la respuesta en bytes. |
| Host: www.example.com | Especifica el dominio e interés, para evitar ambiguedades. Muy útil cuando un dominio tiene alojados más de 1 sitio. |
|Date: | Indica fecha, hora y timezone en que se envió la respuesta.|
|Last-Modified: | Indica fecha, hora y timezone de la última vez que se modificó (en el servidor) el recurso solicitado.|
|If-Modified-Since: | El servidor retorna el recurso solicitado SOLO si fue modificado DESPUÉS de la fecha ingresada. |
|Set-Cookie: | El servidor envía una cookie al cliente. |
|Cookie: | El cliente le envía una cookie al servidor. |

#### Telnet

-   Protocolo antiguo obsoleto. Es un cliente que te permite conectarte a un servidor usando un software que atiende y ejecuta los comandos en la máquina.

#### GET vs POST

La diferencia principal es que el GET envía los datos ingresados en el formulario a través de la URL vía querys (?clave=valor) mientras que POST envía los datos ingresados en el Body del request, por ende es más seguro.

Otras diferencias:

-   Los POST requests no se cachean, los GET pueden cachearse.
-   Los POST request no permanecen en el historial del browser, los GET si.
-   Los POST requests no tienen límites de longitud en cuanto a los datos a enviar, los GET si, ya que las URLs (donde los query parameters se colocan) tienen límites de longitud.

#### SSH

-   Permite ejecutar una conexión remota con un servidor y ejecutar comandos. La data va **cifrada**.
-   Por defecto usa el **puerto 22**.

---

## DNS

#### Definición

-   DNS (Domain Name System) es un protocolo que traduce nombres de dominio (como www.example.com) a direcciones IP, que son identificadores numéricos separados por puntos. La idea es que no tengamos que buscar sitios web por su IP ya que sería muy engorroso de recordar. Recordamos los sitios web por sus nombres de dominio (URL) y DNS los traduce a IPs.
-   Por defecto usa el **puerto 53**.
-   Usa UDP.
-   Además de ser un protocolo, también es un sistema distribuido de forma jerárquica por todo el mundo.

#### Root servers

-   Son servidores DNS que están al principio de la jerarquía de servidores DNS.
-   Son los primeros servidores que los resolvers consultan.
-   Tienen información de los Top Level Domains.

#### Top Level Domains

-   Se dividen en 2 tipos: Generic y Country Code.
    -   Generic: indican el propósito general de la página. ".com" (comercial), ".org" (organización), etc.
    -   Country Code: indican de qué país es el dominio. ".uk" (Reino Unido), ".arg" (Argentina), etc.

#### Servidores autoritativos

-   Son aquellos que poseen información original, actualizada y oficial de los registros DNS de un dominio.
-   Las cachés de servidores no autoritativos pueden tener información desactualizada de un dominio, y pueden tardar bastante en actualizarse.
-   Se dividen en 1 primario y N-1 secundarios. El primario copia su información a los secundarios regularmente, esto se conoce como **transferencia de zona**.

#### Resolver

-   Es un componente de software integrado (una rutina, proceso o librería) en el sistema operativo que resuelve todas nuestras consultas DNS (tanto recursivas como iterativas).
-   Se comunica con otros servidores DNS via Internet.
-   Cuando recibe una consulta, primero chequea su caché. Si no encuentra lo pedido ahí, realiza una consulta (usualmente recursiva) al servidor de DNS configurado como local.

#### Consultas DNS recursivas vs iterativas

-   Las consultas recursivas son aquellas que el resolver resuelve **por completo** una vez el cliente le realiza una solicitud. Si el resolver tiene la respuesta en su caché, le devuelve la respuesta al cliente rápidamente. Si no, va preguntando recursivamente servidor por servidor según lo que le responden hasta traer la respuesta autoritativa.
    -   **Cuando un cliente quiere saber una IP, le realiza una consulta recursiva a su resolver local**.
-   Las consultas iterativas son aquellas donde el resolver le da al cliente una respuesta según lo que tiene en su caché. Si su caché está vacía, devuelve una referencia a otro servidor DNS. El cliente es responsable por ende de hacer las subsecuentes querys según la referencia que el resolver le devolvió.
    -   **Cuando el resolver local necesita saber una IP, realiza consultas iterativas empezando por los root servers**.
-   Si está en caché o estás en el servidor autoritativo entonces la respuesta no es recursiva, es iterativa.

#### Respuestas DNS autoritativas vs no autoritativas

-   Las respuestas autoritativas son las que retornan efectivamente la dirección IP del dominio solicitado, y esta respuesta proviene del servidor autoritativo de ese dominio, y si no, de algun otro servidor que aún posea la IP en su caché.
-   Las respuestas no autoritativas provienen de servidores DNS que no son autoritativos.

#### Delegación de dominios

-   Cuando tenemos subdominios como "example.com" - "test.example.com" hay que delegar.
-   test.example.com tendrá sus propios servidores autoritativos separados de los de example.com.
-   Se crean registros NS en el servidor autoritativo de example.com que apuntan a los servidores autoritativos de test.example.com.
-   En el servidor autoritativo para el dominio example.com tenemos:

```
test.example.com IN NS ns1.test.example.com
ns1.test.example.com IN A 192.168.1.0
```

#### Flags DNS

| Flag | Significado                                          |
| ---- | ---------------------------------------------------- |
| aa   | Si está en 1, la respuesta fue autoritativa.         |
| rd   | Si está en 1, el cliente pidió una query recursiva.  |
| ra   | Si está en 1, el servidor soporta recursión.         |
| qr   | Si está en 1, es una respuesta. Si no, es una query. |

#### Códigos de respuesta DNS

| Código   | Significado                                                                            |
| -------- | -------------------------------------------------------------------------------------- |
| NOERROR  | La query fue exitosa (el dominio existe) pero el registro solicitado puede no existir. |
| NXDOMAIN | El dominio solicitado no existe.                                                       |
| SERVFAIL | Hay un problema técnico con los servidores DNS. Podría ser un firewall.                |
| REFUSED  | El servidor rechazó la consulta por motivos de seguridad o falta de autorización.      |

#### Registros DNS

| Registro | Significado                                                                                                                                                                                     |
| -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| A        | Mappea un nombre de dominio a una dirección IPv4.                                                                                                                                               |
| AAAA     | Mappea un nombre de dominio a una dirección IPv6.                                                                                                                                               |
| PTR      | Mappea una dirección IPv4 a un nombre de dominio.                                                                                                                                               |
| MX       | Servidores de email responsables de **recibir** emails (no enviar) para un nombre de dominio. Cuanto más bajo el valor, más prioridad tiene el MX.                                              |
| TXT      | Información del nombre de dominio.                                                                                                                                                              |
| SRV      | Servicios disponibles dentro de un nombre de dominio.                                                                                                                                           |
| NS       | Servidores autoritativos para un nombre de dominio.                                                                                                                                             |
| CNAME    | Alias de un nombre de dominio.                                                                                                                                                                  |
| SOA      | Información administrativa de una zona DNS. Sirve para configurar y sincronizar a los servers DNS secundarios. Muestra, entre otras cosas, cual de los servidores autoritativos es el primario. |

#### Ejemplo de output del comando dig

![Ejemplo DNS comando dig](https://i.gyazo.com/83bd4f177d4ac91c4745d10baab91221.png)

---

## SMTP

#### Definición

-   Simple Mail Transfer Protocol es un protocolo que se usa cuando un **cliente envía un email a su mail server** y también **cuando un servidor de mail le manda un email a otro servidor de mail**. Esto es porque SMTP puede actuar como cliente o como servidor.
-   Por defecto usa el **puerto 25**.
-   Usa TCP.

#### POP3

-   Protocolo simple, cuando el usuario quiere acceder a sus emails los descarga y estos se borran del servidor.
-   No guarda estado, por ende es eficiente.
-   Ya que no guarda estado, no permite sincronización a través de multiples dispositivos.
-   Por defecto usa el **puerto 110**.
-   Usa TCP.

#### IMAP

-   Protocolo más complejo que permite al usuario leer, borrar, y organizar sus emails en carpetas como si fuera un filesystem.
-   Guarda estado, por ende es menos eficiente.
-   Como guarda estado, permite sincronización a través de multiples dispositivos.
-   Por defecto usa el **puerto 143**.
-   Usa TCP.

#### Encoding de imágenes

-   Tanto SMTP como POP3 e IMAP necesitan encodificar las imágenes para transformarlas a texto al enviar o recibir un email que las contenga, ya que trabajan únicamente con contenido de texto plano.

#### MUA, MSA, MTA, MDA

-   MUA o Mail User Agent es el cliente o programa user-friendly que usan los clientes para enviar o recibir emails. Por ejemplo Outlook o Gmail.
-   MSA o Mail Submission Agent es el responsable de enviar emails salientes de los clientes hacia el MTA.
-   MTA o Mail Transfer Agent es el responsable de enviar emails de un servidor de email a otro, es decir a otro MTA.
-   MDA o Mail Delivery Agent es el responsable de recibir emails de los clientes.
-   De MUA a MSA tenemos una sola conexión. De MTA a MTA depende a qué dominio van los emails. Si 2 emails van al mismo dominio pueden ir en una sola conexión TCP.
-   Resumen de un envío típico de un solo email entre dominios distintos:

```
MUA Cliente → MSA Cliente → MTA Cliente → MTA Servidor → MDA Servidor → MUA Servidor
```

#### Ejemplo simple

-   Si **a@test.com envía un email a b@gmail.com**, el MTA de test.com se encarga de consultar por el registro MX de gmail.com (toma el de mayor prioridad es decir menor valor) y una ves que lo obtiene consulta por la IP (registro A) de ese dominio obtenido. **Lo hace el MTA, no el Resolver.**

    <img src="https://inquest.net/wp-content/uploads/how_email_works.png" alt="Diagrama MUA, MSA, MTA, MDA" width="1000" height="350"/>

---

## FTP

-   Protocolo que permite transferir archivos.
-   Necesita 2 conexiones TCP: una de **control** y otra de **datos**.
-   Tiene 2 modos, Activo y Pasivo, que difieren en cómo se maneja la conexión de datos.

#### Modo Activo

-   El cliente abre uno de sus puertos para la conexión de datos, y **el servidor se conecta al cliente**.
-   Puede ser inseguro.
-   Puede generar problemas de firewall/NAT.
-   No se suele usar hoy en día.

#### Modo Pasivo

-   El servidor abre uno de sus puertos para la conexión de datos, y **el cliente se conecta al servidor**.
-   Suele ser seguro.
-   No suele causar problemas de firewall/NAT.
-   Es el más usado actualmente.
